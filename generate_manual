#!/usr/bin/env bash

###################################################################################################

DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" >/dev/null 2>&1 && pwd)"
DATE="$(date "+%B %e, %Y")"

MANUAL_NAME=$1
MANUAL_IN_DIR=$DIR/$MANUAL_NAME
MANUAL_OUT_DIR=$DIR/export/$MANUAL_NAME

###################################################################################################

error=0

echo ""

# Check if name of manual to be generated has been provided
if [ $# -lt 1 ]; then
    echo "You need to provide the manual name to be generated."
    echo "  Example:"
    echo "    ./generate_manual manual_example"
    echo ""
    exit 1
fi

# Check and remove directory slash (/) of manual name
if [[ "${MANUAL_NAME: -1}" == "/" ]]; then
    MANUAL_NAME=${MANUAL_NAME::-1}
fi

# Check if Pandoc is installed
pandoc -v &> /dev/null
if [[ $? != 0 ]]; then
    echo "Error: Pandoc not found."
    echo "Please install it through \"pandoc_install\" script."
    echo ""
    exit 1
fi

# Create output directory
mkdir -p $MANUAL_OUT_DIR

# Generate HTML, ODT and PDF documents from Markdown plain text files
echo "Creating HTML manual..."
pandoc --self-contained -M date="${DATE}" $MANUAL_IN_DIR/*.md -f markdown -s -o $MANUAL_OUT_DIR/$MANUAL_NAME.html
if [[ $? != 0 ]]; then
    ((error=error+1))
    echo "Error: Can't generate manual in HTML format."
    echo ""
fi
echo "Creating ODT manual..."
pandoc -M date="${DATE}" $MANUAL_IN_DIR/*.md -f markdown -s -o $MANUAL_OUT_DIR/$MANUAL_NAME.odt
if [[ $? != 0 ]]; then
    ((error=error+1))
    echo "Error: Can't generate manual in ODT format."
    echo ""
fi
echo "Creating PDF manual..."
#pandoc -M date="${DATE}" $MANUAL_IN_DIR/*.md -f markdown -s -o $MANUAL_OUT_DIR/$MANUAL_NAME.pdf
#if [[ $? != 0 ]]; then
#    ((error=error+1))
#    echo "Error: Can't generate manual in PDF format."
#    echo ""
#fi
#echo "Creating PDF book..."
#pandoc -H "${MANUAL_IN_DIR}/tex_to_pdf_style.tex" --top-level-division=chapter -M date="${DATE}" $MANUAL_IN_DIR/*.md -f markdown -s -o "${MANUAL_OUT_DIR}/${MANUAL_NAME}_book.pdf"
pandoc -H "${MANUAL_IN_DIR}/tex_to_pdf_style.tex" --top-level-division=chapter --columns=100 -M date="${DATE}" $MANUAL_IN_DIR/*.md -f markdown -s -o "${MANUAL_OUT_DIR}/${MANUAL_NAME}.pdf"
if [[ $? != 0 ]]; then
    ((error=error+1))
    echo "Error: Can't generate book in PDF format."
    echo ""
fi

echo ""
if [ $error -ge 3 ]; then
    echo "Error: Manual can't be created."
    rm -rf $MANUAL_OUT_DIR
else
    echo "Generated Manual placed at: ${MANUAL_OUT_DIR}"
fi
echo ""

exit 0
